name: Python Production CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  security-scan:
    name: ğŸ•µï¸ Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # é‡è¦ï¼šGitleaks éœ€è¦è¯»å– Git å†å²

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # é‡åˆ°æ³„éœ²ç›´æ¥æŠ¥é”™é€€å‡º
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: false
          GITLEAKS_ENABLE_SUMMARY: true

  quality-gate:
    name: ğŸ Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # æ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´ç‰ˆæœ¬
          cache: 'pip' # å¼€å¯ pip ç¼“å­˜ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      - name: Lint with flake8
        # E501 å¿½ç•¥è¡Œè¿‡é•¿ï¼Œæ ¹æ®å›¢é˜Ÿè§„èŒƒè°ƒæ•´
        run: |
          # åœæ­¢æ„å»ºå¦‚æœå­˜åœ¨è¯­æ³•é”™è¯¯æˆ–æœªå®šä¹‰çš„åç§°
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # å°†å…¶è§†ä¸ºè­¦å‘Š
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Tests
        run: pytest
